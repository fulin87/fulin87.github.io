<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  
    <link rel="icon" href="">
  
    
  <title>老鸟眼中的JVM知识体系 | 水货程序员的笔记</title>
  <link rel="stylesheet" href="/content/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" />
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/content/">
      <span>水货程序员的笔记</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/content/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/content/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/content/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/content/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>老鸟眼中的JVM知识体系</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2018年12月04日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/content/categories/java/">java</a>
  </div>



            
            
          </div>
          <blockquote>
<p>写了多年的java代码之后，现在以一个老鸟的视角来看java，真的和刚开始的时候是有天壤之别的，依然记得当初跑出第一个 <em>Hello World</em> 时候的感觉：<em>运行一个程序竟然什么感觉都没有，竟然如此平凡</em>。现在看来，当年的自己还是太稚嫩了，一个简单的 <em>Hello World</em> 其实已经包含了java技术体系中最核心，最重要的东西—–<strong>JVM</strong></p>
</blockquote>
<h3 id="java到底是什么"><a href="#java到底是什么" class="headerlink" title="java到底是什么"></a>java到底是什么</h3><blockquote>
<p>现在大家说java，其实是包含了两部分 <strong>java语言本身</strong> 和 <strong>JVM</strong>,众所周知，java是跨平台的。<br>与其说java是跨平台的，不如说字节码是跨平台的。JVM本身不是跨平台的，不跨平台的JVM可以执行相同的字节码，从而间接的实现了字节码的跨平台运行。这里的字节码不一定是通过java语言编译获取，也可以通过其他语言间接得到，甚至直接编写。</p>
</blockquote>
<p><img src="/content/image/jvmkuapingtai.PNG" alt="java跨平台"></p>
<blockquote>
<p>因此 JVM是java技术的基石。平时我们所说的java规范分为两部分</p>
</blockquote>
<ul>
<li>java语言规范</li>
<li>JVM规范（字节码规范是属于JVM规范的一部分）</li>
</ul>
<h3 id="JVM到底是什么"><a href="#JVM到底是什么" class="headerlink" title="JVM到底是什么"></a>JVM到底是什么</h3><p> 通俗的说JVM就是运行在主机上的一个程序，是一个java进程。JVM由三大部分组成</p>
<ul>
<li>类加载子系统</li>
<li>运行时数据区</li>
<li>执行引擎</li>
</ul>
<p> 平时我们所说的堆和栈都是属于运行时数据区。JVM的类加载子系统是非常强大和灵活的，JVM允许我们在程序运行的过程中加载类，这给我们提供了很大的灵活性，也为热部署提供了可能。</p>
<h3 id="jvm的运行模式"><a href="#jvm的运行模式" class="headerlink" title="jvm的运行模式"></a>jvm的运行模式</h3><pre><code>client 模式 java -client启用
server 模式 java -server启动
</code></pre><p>client模式启动的是Client VM的实现，可以减少启动时间和内存占用,一般用在java客户端上,比如java的GUI程序</p>
<p>server模式启动的是server VM的实现，启动时间会有点长，但是程序运行速度更快</p>
<p>不管是client还是server模式有些底层技术是通用的：</p>
<pre><code>自适应编译(JIT)
快速内存分配和垃圾回收
线程同步
</code></pre><h3 id="jvm调优的目标"><a href="#jvm调优的目标" class="headerlink" title="jvm调优的目标"></a>jvm调优的目标</h3><pre><code>尽可能大的吞吐量,尽可能小的GC停顿时间（吞吐量是GC时间在总时间中的占比，比值越小，吞吐量越高）
</code></pre><h3 id="JVM的垃圾收集器"><a href="#JVM的垃圾收集器" class="headerlink" title="JVM的垃圾收集器"></a>JVM的垃圾收集器</h3><pre><code>串行收集器 &gt;&gt; 适合单处理器小数据集
并行收集器 &gt;&gt; 吞吐量优先，多个线程执行GC，系统一定会出现短时Stop the World
并发收集器 &gt;&gt; 响应时间优先，GC时系统不会出现Stop the World
</code></pre><ul>
<li><p>选择垃圾收集器的原则</p>
<ul>
<li>如果应用的数据集小于100M，或者在单个处理器上运行，没有暂停时间要求，则使用串行收集器</li>
<li>如果系统的吞吐量是第一优先级而且系统的暂停是可以接受的，使用并行收集器</li>
<li>如果系统的响应时间比吞吐量更重要，并且垃圾收集暂停必须小于1s,则使用并发收集器</li>
</ul>
</li>
</ul>
<p>###<br>    -XX:+UseSerialGC 使用串行收集器（串行）<br>    -XX:+UseParallelGC 使用并行收集器(并行）<br>    -XX:-UseParallelOldGC 关闭并行压缩（并行）<br>    -XX:+UseConcMarkSweepGC 启用CMS收集器(并发）<br>    -XX:+UseG1GC    启用G1收集器(并发）<br>    -XX:ParallelGCThreads=<n> 调整并行收集器的GC线程数量</n></p>
<h3 id="java字节码"><a href="#java字节码" class="headerlink" title="java字节码"></a>java字节码</h3><p>  字节码的整体结构,按照顺序依次是</p>
<pre><code> * Magic Number 
     &gt; 魔数，4个字节。值为0xCAFEBABE 由java语言的作者James Gosling定义的
* Version
    &gt; 版本号，4个字节,前两个字节是minor_version，后两个字节是major_version
* Constant Pool
    &gt; 常量池，2 + n 个字节
* Access Flags
    &gt; 访问标志符,2个字节
* This Class Name
    &gt; 当前类的名字,2个字节
* Supper Class Name
    &gt; 父类的名字,2个字节
* Interfaces
    &gt; 接口,2+n个字节。一个类可能会实现多个接口，所以是2+n个字节
* Fields
    &gt; 成员变量,2+n个字节
* Method
    &gt; 方法,2+n个字节
* Attributes
    &gt; 属性，2+n个字节
</code></pre><p><img src="/content/image/leijiegou.PNG" alt="字节码结构"></p>
<p><img src="/content/image/leijiegou1.PNG" alt="字节码结构1"></p>
<h3 id="volatile为什么不能实现线程安全"><a href="#volatile为什么不能实现线程安全" class="headerlink" title="volatile为什么不能实现线程安全"></a>volatile为什么不能实现线程安全</h3><p><a href="https://blog.csdn.net/qq_33330687/article/details/80990729" target="_blank" rel="noopener">为什么volatile不能保证线程安全</a></p>
<p><a href="https://blog.csdn.net/wuzhilon88/article/details/49201891" target="_blank" rel="noopener">jvm调优</a></p>
<h3 id="平时遇到的异常"><a href="#平时遇到的异常" class="headerlink" title="平时遇到的异常"></a>平时遇到的异常</h3><h4 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h4><pre><code>/**
 * 
 * @author fulin16
 * 
 * 模拟 Java heap space 溢出
 * 运行参数：-verbose:gc -Xms10M -Xmx10M -Xss128k -XX:+PrintGCDetails
 */
class Person{}
public class HeapException {
    public static void main(String[] args) {
        List&lt;Person&gt; list = new ArrayList&lt;Person&gt;();
        while(true){
            list.add(new Person());
        }
    }
}

//堆中存放的是实例化的对象，如果堆中的对象
</code></pre><blockquote>
<p>异常堆栈</p>
</blockquote>
<pre><code>[GC (Allocation Failure) [PSYoungGen: 2528K-&gt;496K(2560K)] 6226K-&gt;6244K(9728K), 0.0036614 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Ergonomics) [PSYoungGen: 496K-&gt;0K(2560K)] [ParOldGen: 5748K-&gt;5117K(7168K)] 6244K-&gt;5117K(9728K), [Metaspace: 2660K-&gt;2660K(1056768K)], 0.0733379 secs] [Times: user=0.16 sys=0.00, real=0.07 secs] 
[GC (Allocation Failure) [PSYoungGen: 2048K-&gt;512K(2560K)] 7165K-&gt;7180K(9728K), 0.0027150 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Ergonomics) [PSYoungGen: 512K-&gt;0K(2560K)] [ParOldGen: 6668K-&gt;6227K(7168K)] 7180K-&gt;6227K(9728K), [Metaspace: 2660K-&gt;2660K(1056768K)], 0.0365703 secs] [Times: user=0.14 sys=0.00, real=0.04 secs] 
[Full GC (Ergonomics) [PSYoungGen: 1391K-&gt;863K(2560K)] [ParOldGen: 6227K-&gt;6735K(7168K)] 7618K-&gt;7599K(9728K), [Metaspace: 2660K-&gt;2660K(1056768K)], 0.0618754 secs] [Times: user=0.11 sys=0.00, real=0.06 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 863K-&gt;863K(2560K)] [ParOldGen: 6735K-&gt;6724K(7168K)] 7599K-&gt;7588K(9728K), [Metaspace: 2660K-&gt;2660K(1056768K)], 0.0571520 secs] [Times: user=0.11 sys=0.00, real=0.06 secs] 
Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space
    at java.util.Arrays.copyOf(Arrays.java:3210)
    at java.util.Arrays.copyOf(Arrays.java:3181)
    at java.util.ArrayList.grow(ArrayList.java:261)
    at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:235)
    at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:227)
    at java.util.ArrayList.add(ArrayList.java:458)
    at com.fulin.exception.HeapException.main(HeapException.java:27)
Heap
 PSYoungGen      total 2560K, used 945K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)
  eden space 2048K, 46% used [0x00000000ffd00000,0x00000000ffdec6e0,0x00000000fff00000)
  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)
  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)
 ParOldGen       total 7168K, used 6724K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)
  object space 7168K, 93% used [0x00000000ff600000,0x00000000ffc91060,0x00000000ffd00000)
 Metaspace       used 2692K, capacity 4486K, committed 4864K, reserved 1056768K
  class space    used 289K, capacity 386K, committed 512K, reserved 1048576K
</code></pre><p>###JVM相关的比较权威的人</p>
<ul>
<li>R大</li>
</ul>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#java到底是什么"><span class="toc-number">1.</span> <span class="toc-text">java到底是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM到底是什么"><span class="toc-number">2.</span> <span class="toc-text">JVM到底是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jvm的运行模式"><span class="toc-number">3.</span> <span class="toc-text">jvm的运行模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jvm调优的目标"><span class="toc-number">4.</span> <span class="toc-text">jvm调优的目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM的垃圾收集器"><span class="toc-number">5.</span> <span class="toc-text">JVM的垃圾收集器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java字节码"><span class="toc-number">6.</span> <span class="toc-text">java字节码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile为什么不能实现线程安全"><span class="toc-number">7.</span> <span class="toc-text">volatile为什么不能实现线程安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#平时遇到的异常"><span class="toc-number">8.</span> <span class="toc-text">平时遇到的异常</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#堆溢出"><span class="toc-number">8.1.</span> <span class="toc-text">堆溢出</span></a></li></ol></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2019 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/content/lib/in-view.min.js"></script>
<script src="/content/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>


</body>
</html>
